<!DOCTYPE html>
<html>
<head>
  <title>Svah√∏a</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22%3E%3Ctext%20y=%22.9em%22%20font-size=%2290%22%3EüèÉ%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
  <script src="GPXParser.min.js"></script>
  
  <style>
    html, body{ padding: 0; margin: 0; height: 100vh; width: 100%; }
    body {
        display: flex; flex-direction: column;
        #map { flex: 1; }
    }
    .marker {
        background-image: url('marker-icon.png');
        font-weight: 700;
        span {
            position: relative;
            top: -10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 14px;
        }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info" style="padding: 4px 5px 6px 5px;">
    <div>
      <input id="slider" type="range" disabled
        style="display: block; width: 100%;"
        min="0" max="2000" step="1" value="0">
    </div>
    <div
      style="display:flex; justify-content:space-between; align-items:center;">
        Start
        <span id="time">00:00:00</span>
        <a id="wheel" style="padding: 4px; text-decoration: none;"
          title="Innstillinger" href="#settings">‚öôÔ∏è </a>
        M√•l
    </div>
  </div>

  <div id="settings" style="
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: #f9f9f9; padding: 20px;
    ">
    <header>
      <h2>Innstillinger</h2>
    </header>
    <div id="list"></div>
    <div><button id="close">Lagre</button></div>
  </div>

<script>
['load', 'resize'].forEach(evnt => window.addEventListener(evnt,
    function() {
        document.body.style.height = window.innerHeight + 'px';
    })
);

(async function f() {

let filenames = [
    //'Si2018.gpx',
    //'Si2019.gpx',
    //'Si2020.gpx',
    //'Ri2022.gpx',
    //'Mo2022.gpx',
    //'Si2022.gpx',
    'Ri2023.gpx',
    'Mo2023.gpx',
    'Si2023.gpx',
    'Ri2024.gpx',
    'Mo2024.gpx',
    'Si2024.gpx',
    'Ma2024.gpx',
    'Bj2024.gpx',
    'Ri2025.gpx',
    'Mo2025.gpx',
    'Ma2025.gpx',
    'Bj2025.gpx',
    'Si2025.gpx',
];

let showrun = filenames.map((_, i) => i>2);

let runs = filenames.map((name, i) => {
    let parts = name.split('20');
    return {
        "name": parts[0],
        "year": parts[1].split('.')[0],
        "indx": i,
    };
});

document.getElementById('wheel').onclick = (e) => {

    let div = document.createElement('div');

    let table = document.createElement('table');
    let row = document.createElement('tr');
    row.appendChild(document.createElement('th'));
    let names = ['Bj','Ma','Mo','Ri','Si'];
    names.forEach((name) => {
        let th = document.createElement('th');
        th.appendChild(document.createTextNode(name));
        row.appendChild(th);
    });
    table.appendChild(row);

    let runsByYear = {};
    for (let idx in runs) {
        let run = runs[idx];
        let v = runsByYear[run.year] || {};
        v[run.name] = run;
        runsByYear[run.year] = v;
    }
    let years = Object.keys(runsByYear);
    years.sort();
    for (let idx in years) {
        let y = years[idx];
        row = document.createElement('tr');
        let td = document.createElement('td');
        td.appendChild(document.createTextNode(y));
        row.appendChild(td);
        names.forEach((name) => {
            td = document.createElement('td');
            if (runsByYear[y][name]) {
                let input = document.createElement('input');
                input.setAttribute('type', 'checkbox');
                input.setAttribute('id', `show-${y}-${name}`);
                input.checked = showrun[runsByYear[y][name].indx];
                td.appendChild(input);
            }
            row.appendChild(td);
        });
        table.appendChild(row);
    }

    div.appendChild(table);

    div.setAttribute('id', 'list');
    document.getElementById('list').replaceWith(div);
    document.getElementById('settings').style.display = 'block';
    event.preventDefault();
};
document.getElementById('close').onclick = () => {
    document.querySelectorAll('input[type="checkbox"]').forEach((cb, i) => {
        let parts = cb.id.split('-');
        let y = parts[1];
        let name = parts[2];
        for (let idx in runs) {
            let run = runs[idx];
            if (run.name == name && run.year == y)
                showrun[run.indx] = cb.checked;
        }
    });
    if (!showrun.reduce((acc, cur) => acc || cur)) return;
    document.getElementById('settings').style.display = 'none';
    updateMap();
};

let filesPromise = Promise.all(filenames.map(name =>
    fetch(name).then(resp => resp.text())));

let map = L.map('map').setView([62.721, 9.467], 13);

let tile = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
});
tile.addTo(map);

let files = await filesPromise;

let routePromises = files.map((file) =>
    new Promise((resolve) =>
        new L.GPX(file, { async: true,
            marker_options: { endIconUrl: '', startIconUrl: '' } })
            .on('loaded', function(e){ resolve(e.target); })));

let routes = await Promise.all(routePromises);

let maxTime = Math.max(...routes.map(r => r.get_total_time()));

let parsed = files.map(file => {
    let parser = new gpxParser();
    parser.parse(file);
    return parser;
});

let markers = filenames.map((filename, idx) => {
    let point = parsed[idx].tracks[0].points[0];
    let label = filename.replace(/20([0-9]+)\.gpx$/i, "'$1");
    return L.marker([point.lat, point.lon], { icon: L.divIcon({
        html: "<span>" + label + "</span>",
        iconAnchor: [12,41],
        iconSize: [25,41],
        popupAnchor: [1,-34],
        className: 'marker'
    }) });
});

function updateMap() {
    routes.forEach((route, i) => {
        if (showrun[i] && !map.hasLayer(route))
            route.addTo(map);
        else if (!showrun[i] && map.hasLayer(route))
            route.remove();
        if (i == 0) map.fitBounds(route.getBounds());
    });
    markers.forEach((marker, i) => {
        if (showrun[i] && !map.hasLayer(marker))
            marker.addTo(map);
        else if (!showrun[i] && map.hasLayer(marker))
            marker.remove();
    });
}


function setupSlider() {

let slider = document.getElementById('slider');
let max = slider.getAttribute('max');

// populate positions array:
let pos = parsed.map(_ => []);
let startTime = parsed.map(run =>
    run.tracks[0].points[0].time.getTime());
let index = parsed.map(_ => 0);
for (let i = 0; i <= max; i++) {
    let time = maxTime * i / max;
    for (let runIdx in parsed) {
        let points = parsed[runIdx].tracks[0].points;
        while (index[runIdx] < points.length - 1 &&
                points[index[runIdx]].time.getTime()
                - startTime[runIdx] < time) {
            index[runIdx]++;
        }
        pos[runIdx][i] = points[index[runIdx]];
    }
}

slider.addEventListener('input', function(e) {
    let time = maxTime * this.value / max;
    document.getElementById("time").innerHTML = formatTime(time);
    for (let run in parsed) {
        let point = pos[run][this.value];
        if (showrun[run])
            markers[run].setLatLng([point.lat, point.lon]);
    }
});
slider.disabled = false;
slider.value = max / 4;
slider.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
}

function formatTime(millis) {
    let secs = parseInt(millis / 1000);
    let mins = parseInt(secs / 60);
    let hrs = parseInt(mins / 60);

    let seconds = secs % 60;
    let minutes = mins % 60;
    let hours = hrs % 24;
    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;

    return hours + ":" + minutes + ":" + seconds;
}

updateMap();
setupSlider();

})();
</script>
</body>
</html>

